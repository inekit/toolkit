# Конфигурация для мониторинга и расширенного логирования nginx
# Разместить в /etc/nginx/conf.d/monitoring.conf

# Форматы логов для мониторинга
log_format detailed '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   'rt=$request_time uct="$upstream_connect_time" '
                   'uht="$upstream_header_time" urt="$upstream_response_time" '
                   'cs=$upstream_cache_status';

log_format security_blocked '$remote_addr - $remote_user [$time_local] '
                           'BLOCKED: "$request" $status '
                           '"$http_referer" "$http_user_agent" '
                           'reason="$http_x_blocked_reason"';

log_format performance '$remote_addr - $remote_user [$time_local] '
                     'PERF: "$request" $status $body_bytes_sent '
                     'rt=$request_time uct="$upstream_connect_time" '
                     'uht="$upstream_header_time" urt="$upstream_response_time"';

# Логирование для мониторинга
access_log /var/log/nginx/access.log detailed;
access_log /var/log/nginx/security.log security_blocked;
access_log /var/log/nginx/performance.log performance;

# Статус страница для мониторинга (защищенная)
location /nginx_status {
    stub_status on;
    access_log off;
    
    # Защита от внешнего доступа
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
    
    # Дополнительные заголовки безопасности
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";
}

# Логирование медленных запросов
location ~* \.(php|jsp|asp)$ {
    access_log /var/log/nginx/slow_requests.log performance;
}

# Логирование ошибок 4xx и 5xx
error_log /var/log/nginx/error_4xx.log warn;
error_log /var/log/nginx/error_5xx.log error;

# Логирование подозрительной активности
map $status $loggable {
    ~^[23] 0;
    ~^[45] 1;
    default 1;
}

# Условное логирование
access_log /var/log/nginx/errors.log detailed if=$loggable;
