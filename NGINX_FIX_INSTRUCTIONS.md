# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ nginx "invalid number of map parameters"

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏–∑-–∑–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–∏–≤ –≤ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```bash
nginx -t
```

### 2. –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–∏–≤:

#### **–í `http` –±–ª–æ–∫–µ (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ):**

- `map`
- `limit_req_zone`
- `log_format`
- `gzip`
- –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

#### **–í `server` –±–ª–æ–∫–µ (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ):**

- `ssl_certificate`
- `root`
- `location`
- `add_header`

#### **–í `location` –±–ª–æ–∫–µ (—Ä–∞–∑—Ä–µ—à–µ–Ω–æ):**

- `if` –¥–∏—Ä–µ–∫—Ç–∏–≤—ã
- `limit_req`
- `try_files`
- `expires`

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

```nginx
http {
    # Rate limiting –∑–æ–Ω—ã
    limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;

    # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–æ—Ç–æ–≤
    map $http_user_agent $bad_bot {
        default 0;
        ~* "masscan" 1;
        ~* "nmap" 1;
    }

    server {
        location / {
            if ($bad_bot = 1) {
                return 403;
            }
            limit_req zone=general burst=20 nodelay;
        }
    }
}
```

### 4. –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:

#### **‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:**

```nginx
server {
    map $http_user_agent $bad_bot { ... }  # map –≤ server –±–ª–æ–∫–µ
}

location / {
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;  # zone –≤ location
}
```

#### **‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:**

```nginx
http {
    map $http_user_agent $bad_bot { ... }  # map –≤ http –±–ª–æ–∫–µ
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;  # zone –≤ http –±–ª–æ–∫–µ
}

server {
    location / {
        limit_req zone=api burst=20 nodelay;  # limit_req –≤ location
    }
}
```

## üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞:

```bash
nginx -t
```

### 2. –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç:

```bash
systemctl reload nginx
```

### 3. –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
tail -f /var/log/nginx/error.log

# –ò—Å–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É
nginx -t
```

## üìã –ß–µ–∫-–ª–∏—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

- [ ] `map` –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `http` –±–ª–æ–∫–µ
- [ ] `limit_req_zone` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `http` –±–ª–æ–∫–µ
- [ ] `if` –¥–∏—Ä–µ–∫—Ç–∏–≤—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `location` –±–ª–æ–∫–µ
- [ ] `limit_req` –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `location` –±–ª–æ–∫–µ
- [ ] –í—Å–µ –±–ª–æ–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç—ã
- [ ] –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω –∫–æ–º–∞–Ω–¥–æ–π `nginx -t`

---

**üí° –°–æ–≤–µ—Ç**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `nginx -t` –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!
